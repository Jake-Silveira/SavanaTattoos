<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign In</title>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4"></script>
  <link rel="stylesheet" href="/backend/public/signIn.css">
</head>
<body>
  <div id="titleBackground">
    <img id="titleLogo" src="/images/logo.png" alt="Raven's Nest Logo">
    <div class="navBtnContainer">
      <button class="navBtn" onclick="window.location.href='https://www.ravensnest.ink/index.html'">Home</button>
      <img id="menuBtn" src="/images/menu-icon.png" alt="Menu" onclick="openMenu()">
    </div>
  </div>
  <div class="contentContainer">
    <h2 id="formTitle" class="signInLabel">Sign In</h2>
    <div id="toast"></div>

    <div class="btn-group">
      <button class="navBtn" onclick="showForm('login')">Sign In</button>
      <button class="navBtn" onclick="showForm('signup')">Sign Up</button>
      <button class="navBtn" onclick="showForm('reset')">Reset Password</button>
    </div>

    <!-- Login Form -->
    <form id="loginForm" class="signInForm" onsubmit="handleLogin(event)">
      <fieldset>
        <label for="loginEmail" class="signInLabel required">Email</label>
        <input type="email" id="loginEmail" class="signInInput" placeholder="Email" required />
        <label for="loginPassword" class="signInLabel required">Password</label>
        <input type="password" id="loginPassword" class="signInInput" placeholder="Password" required />
        <button type="submit" id="signInSubmitBtn">Sign In</button>
      </fieldset>
    </form>

    <!-- Sign Up Form -->
    <form id="signupForm" class="signInForm" style="display:none" onsubmit="handleSignup(event)">
      <fieldset>
        <label for="signupEmail" class="signInLabel required">Email</label>
        <input type="email" id="signupEmail" class="signInInput" placeholder="Email" required />
        <label for="signupPassword" class="signInLabel required">Password</label>
        <input type="password" id="signupPassword" class="signInInput" placeholder="Password" required minlength="8" />
        <button type="submit" id="signInSubmitBtn">Sign Up</button>
      </fieldset>
    </form>

    <!-- Reset Password Form -->
    <form id="resetForm" class="signInForm" style="display:none" onsubmit="handleReset(event)">
      <fieldset>
        <label for="resetEmail" class="signInLabel required">Email</label>
        <input type="email" id="resetEmail" class="signInInput" placeholder="Email" required />
        <button type="submit" id="signInSubmitBtn">Send Reset Link</button>
      </fieldset>
    </form>

    <!-- Update Password Form -->
    <form id="updatePasswordForm" class="signInForm" style="display:none" onsubmit="handleUpdatePassword(event)">
      <fieldset>
        <label for="newPassword" class="signInLabel required">New Password</label>
        <input type="password" id="newPassword" class="signInInput" placeholder="New Password" required minlength="8" />
        <label for="confirmPassword" class="signInLabel required">Confirm Password</label>
        <input type="password" id="confirmPassword" class="signInInput" placeholder="Confirm Password" required minlength="8" />
        <button type="submit" id="signInSubmitBtn">Update Password</button>
      </fieldset>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const SUPABASE_URL = 'https://klsgtwlcvpngkwbzromr.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtsc2d0d2xjdnBuZ2t3Ynpyb21yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMTUxNDMsImV4cCI6MjA2ODc5MTE0M30.KZnF7Rp_tabRNk7VSY44KYojYzLPAcsp96I07Kxd1EU';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const toastEl = document.getElementById('toast');

      window.showToast = function(message) {
        toastEl.textContent = message;
        toastEl.classList.add('show');
        setTimeout(() => {
          toastEl.classList.remove('show');
        }, 3000);
      };

      window.showForm = function(form) {
        ['login', 'signup', 'reset', 'updatePassword'].forEach(f => {
          document.getElementById(f + 'Form').style.display = 'none';
        });
        document.getElementById(form + 'Form').style.display = 'flex';
        document.getElementById('formTitle').textContent =
          form === 'login' ? 'Sign In' :
          form === 'signup' ? 'Sign Up' :
          form === 'reset' ? 'Reset Password' : 'Update Password';
      };

      window.handleLogin = async function(event) {
        event.preventDefault();
        const button = event.target.querySelector('button[type="submit"]');
        button.disabled = true;

        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        console.log('[INFO] Initiating sign-in', { email });

        const response = await fetch('https://www.ravensnest.ink/sign-in', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
          credentials: 'include'
        });

        const { user, access_token, error } = await response.json();

        if (error || !response.ok) {
          showToast('Login failed: ' + (error?.message || 'Invalid credentials'));
          console.error('[ERROR] Login failed', { error: error?.message, email });
          button.disabled = false;
          return;
        }

        if (access_token) {
          sessionStorage.setItem('access_token', access_token);
          console.log('[INFO] Token stored in sessionStorage', { token: access_token, email });
        } else {
          showToast('Login failed: No access token');
          console.error('[ERROR] No access token received', { email });
          button.disabled = false;
          return;
        }

        showToast('Signed in! Redirecting...');

        const { data: userData, error: userError } = await supabase.auth.getUser(access_token);
        if (userError) {
          showToast('Failed to fetch user info: ' + userError.message);
          console.error('[ERROR] Failed to fetch user info', { error: userError.message, email });
          sessionStorage.removeItem('access_token');
          button.disabled = false;
          return;
        }

        const role = userData.user?.app_metadata?.role || 'user';
        console.log('[INFO] User role', { role, userId: userData.user.id, email });

        try {
          const debugResponse = await fetch('https://www.ravensnest.ink/debug/headers', { credentials: 'include' });
          const debugData = await debugResponse.json();
          console.log('[DEBUG] Headers and cookies sent', debugData);
        } catch (debugError) {
          console.error('[ERROR] Failed to debug headers', { error: debugError.message, email });
        }

        if (role === 'admin') {
          console.log('[INFO] Redirecting to admin dashboard', { email });
          window.location.href = `https://www.ravensnest.ink/admin/dashboard?token=${access_token}`;
        } else {
          console.log('[INFO] Redirecting to index', { email });
          window.location.href = `https://www.ravensnest.ink/index.html?token=${access_token}`;
        }
        button.disabled = false;
      };

      window.handleSignup = async function(event) {
        event.preventDefault();
        const button = event.target.querySelector('button[type="submit"]');
        button.disabled = true;

        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;

        console.log('[INFO] Initiating sign-up', { email });

        const passwordError = validatePassword(password);
        if (passwordError) {
          showToast(passwordError);
          console.error('[ERROR] Password validation failed', { error: passwordError, email });
          button.disabled = false;
          return;
        }

        const { error } = await supabase.auth.signUp({
          email,
          password,
          options: { data: { role: 'user' } }
        });

        if (error) {
          showToast('Sign-up failed: ' + error.message);
          console.error('[ERROR] Sign-up failed', { error: error.message, email });
          button.disabled = false;
          return;
        }

        showToast('Sign-up successful! Check your email to confirm.');
        console.log('[INFO] Sign-up successful', { email });
        button.disabled = false;
      };

      window.handleReset = async function(event) {
        event.preventDefault();
        const button = event.target.querySelector('button[type="submit"]');
        button.disabled = true;

        const email = document.getElementById('resetEmail').value;

        console.log('[INFO] Initiating password reset', { email });

        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: 'https://www.ravensnest.ink/signIn.html'
        });

        if (error) {
          showToast('Reset failed: ' + error.message);
          console.error('[ERROR] Reset failed', { error: error.message, email });
          button.disabled = false;
          return;
        }

        showToast('Reset email sent!');
        console.log('[INFO] Reset email sent', { email });
        button.disabled = false;
      };

      window.handleUpdatePassword = async function(event) {
        event.preventDefault();
        const button = event.target.querySelector('button[type="submit"]');
        button.disabled = true;

        const newPass = document.getElementById('newPassword').value;
        const confirmPass = document.getElementById('confirmPassword').value;

        console.log('[INFO] Initiating password update');

        if (newPass !== confirmPass) {
          showToast('Passwords do not match.');
          console.error('[ERROR] Passwords do not match');
          button.disabled = false;
          return;
        }

        const passwordError = validatePassword(newPass);
        if (passwordError) {
          showToast(passwordError);
          console.error('[ERROR] Password validation failed', { error: passwordError });
          button.disabled = false;
          return;
        }

        const { error } = await supabase.auth.updateUser({ password: newPass });
        if (error) {
          showToast('Failed to update password: ' + error.message);
          console.error('[ERROR] Failed to update password', { error: error.message });
          button.disabled = false;
          return;
        }

        showToast('Password updated! You can now log in.');
        console.log('[INFO] Password updated');
        showForm('login');
        button.disabled = false;
      };

      function validatePassword(password) {
        const minLength = 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /\d/.test(password);
        if (password.length < minLength || !hasUpperCase || !hasLowerCase || !hasNumbers) {
          return 'Password must be at least 8 characters long and include uppercase, lowercase, and numbers.';
        }
        return null;
      }

      const url = new URL(window.location.href);
      const isReset = url.searchParams.get('type') === 'recovery';
      if (isReset) {
        showForm('updatePassword');
      }

      async function authFetch(url, options = {}) {
        const token = sessionStorage.getItem('access_token');
        if (!options.headers) options.headers = {};
        if (token) {
          options.headers['Authorization'] = `Bearer ${token}`;
        }
        options.credentials = 'include';
        console.log('[DEBUG] authFetch', { url, hasToken: !!token });
        return fetch(url, options);
      }

      // Placeholder for menu functionality
      window.openMenu = function() {
        console.log('[INFO] Menu button clicked');
        // Add modal menu logic here if needed
      };
    });
  </script>
</body>
</html>